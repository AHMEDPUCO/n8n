# .gitlab-ci.yml
stages:
  - security-scan

variables:
  # El namespace donde aplicaremos el Scan
  KUBE_NAMESPACE: "scb"

# Este job usa una imagen que ya tiene kubectl
image:
  name: bitnami/kubectl:latest
  entrypoint: [""]

semgrep-scan:
  stage: security-scan
  # Solo corre en la rama 'main'
  only:
    - main
  script:
    - echo "Iniciando escaneo de seguridad con secureCodeBox..."
    # 1. Decodificar el KUBE_CONFIG desde la variable de GitLab
    - echo $KUBE_CONFIG_BASE64 | base64 -d > kubeconfig.yaml
    - export KUBECONFIG=$PWD/kubeconfig.yaml
    
    # 2. Verificar conexión (Opcional pero recomendado)
    - kubectl config get-contexts
    - kubectl -n $KUBE_NAMESPACE get pods
    
    # 3. ¡El Trigger! Aplicamos el manifiesto del escaneo
    # Esto crea el recurso "Scan" en Kubernetes
    - echo "Aplicando manifiesto de escaneo: scb-scan.yaml"
    - kubectl -n $KUBE_NAMESPACE apply -f scb-scan.yaml
    
    # 4. (Opcional) Esperar a que termine
    # Para este ejemplo, solo lo disparamos y dejamos que sCB se encargue.
    # En un pipeline real, podrías añadir un script que espere (kubectl wait).
    - echo "Escaneo 'Scan' creado en Kubernetes. secureCodeBox tomará el control."