stages:
  - security-scan

variables:
  KUBE_NAMESPACE: "scb"

semgrep-scan:
  image:
    name: bitnami/kubectl:latest
    entrypoint: [""]
  stage: security-scan
  only:
    - main
  script:
    - echo "Iniciando escaneo de seguridad con secureCodeBox..."
    - echo "$KUBE_CONFIG_BASE64" | base64 -d > kubeconfig.yaml   # 1. Decodificar kubeconfig
    - export KUBECONFIG=$PWD/kubeconfig.yaml
    - kubectl config get-contexts                                 # 2. Verificar conexión
    - kubectl -n "$KUBE_NAMESPACE" get pods
    - echo "Aplicando manifiesto de escaneo: scb-scan.yaml"       # 3. Trigger scan
    - kubectl -n "$KUBE_NAMESPACE" apply -f scb-scan.yaml
    - echo "Escaneo creado en Kubernetes. secureCodeBox tomará el control." # 4. Confirmación
