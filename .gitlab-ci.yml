stages:
  - security-scan

variables:
  KUBE_NAMESPACE: "scb"

image:
  name: bitnami/kubectl:latest
  entrypoint: [""]

semgrep-scan:
  stage: security-scan
  only:
    - main

  # Opcional pero útil: prepara KUBECONFIG antes del script
  before_script:
    - echo "Configurando acceso a Kubernetes..."
    - 'echo "$KUBE_CONFIG_BASE64" | base64 -d > kubeconfig.yaml'
    - export KUBECONFIG="$CI_PROJECT_DIR/kubeconfig.yaml"
    - kubectl version --client

  script:
    - echo "Iniciando escaneo de seguridad con secureCodeBox..."
    - echo "Verificando conexion con Kubernetes..."
    - kubectl config get-contexts
    - kubectl -n "$KUBE_NAMESPACE" get pods
    - echo "Aplicando manifiesto de escaneo: scb-scan.yaml"
    - kubectl -n "$KUBE_NAMESPACE" apply -f scb-scan.yaml
    - echo "Escaneo 'Scan' creado en Kubernetes. secureCodeBox tomará el control."
