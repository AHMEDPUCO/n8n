stages:
  - security-scan

variables:
  KUBE_NAMESPACE: "scb"

semgrep-scan:
  stage: security-scan
  tags:
    - k8s-runner
  image:
    name: bitnami/kubectl:latest
    entrypoint: [""]
  only:
    - main
  script:
    - echo "Â¡Corriendo dentro de un pod de Kubernetes!"
    - echo "Verificando conexion (dentro-del-cluster)..."
    - kubectl config get-contexts
    - echo "Creando (no aplicando) manifiesto de escaneo en sCB..."
    - kubectl -n $KUBE_NAMESPACE create -f scb-scan.yaml
    - echo "Escaneo 'Scan' creado en Kubernetes."
    - echo "Esperando a que el escaneo termine..."
    - kubectl -n $KUBE_NAMESPACE get scan
    - echo "Escaneo completado. Desplegando resultados a DefectDojo..."
