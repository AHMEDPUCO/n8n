# .gitlab-ci.yml
stages:
  - security-scan

variables:
  KUBE_NAMESPACE: "secure-code-box"

image:
  name: bitnami/kubectl:latest
  entrypoint: [""]

semgrep-scan:
  stage: security-scan
  only:
    - main
  script:
    - echo "Iniciando escaneo de seguridad con secureCodeBox..."
    - echo $KUBE_CONFIG_BASE64 | base64 -d > kubeconfig.yaml
    - export KUBECONFIG=$PWD/kubeconfig.yaml
    - echo "Verificando conexion con Kubernetes..."
    - kubectl config get-contexts
    - kubectl -n $KUBE_NAMESPACE get pods
    - echo "Aplicando manifiesto de escaneo: scb-scan.yaml"
    - kubectl -n $KUBE_NAMESPACE apply -f scb-scan.yaml
    - echo "Escaneo 'Scan' creado en Kubernetes. secureCodeBox tomar√° el control."